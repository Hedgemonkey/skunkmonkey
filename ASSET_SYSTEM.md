# Asset System Documentation

## Overview

This document explains the asset loading system used in the Skunk Monkey Django application. The system uses Vite.js as a frontend build tool and provides a clean integration with Django's static files system.

## Important Note About manifest.json Files

The application uses two copies of the manifest.json file:

1. `/static/manifest.json` - Primary manifest generated by Vite (used in development)
2. `/staticfiles/manifest.json` - Copy used by Django's collectstatic process (used in production)

**The Enhanced Build Process:** We've modified the post-build script to ensure both files contain identical content, preventing resolution issues between development and production environments.

## Directory Structure

The asset system maintains a logical structure for JavaScript and CSS files:

```
/static/
  ├── manifest.json       # Generated by Vite, maps logical names to file paths
  ├── js/
  │   ├── core/           # Core functionality JavaScript
  │   ├── home/           # Home-specific JavaScript
  │   ├── products/       # Product-specific JavaScript
  │   ├── shop/           # Shop-specific JavaScript
  │   ├── users/          # User-specific JavaScript
  │   ├── staff/          # Admin/staff JavaScript
  │   ├── common/         # Shared utilities
  │   ├── chunks/         # Generated code chunks
  │   └── vendor/         # Third-party libraries
  ├── css/
  │   ├── core/           # Core styles
  │   ├── home/           # Home-specific styles
  │   ├── products/       # Product-specific styles
  │   ├── shop/           # Shop-specific styles
  │   ├── users/          # User-specific styles
  │   ├── staff/          # Admin/staff styles
  │   └── common/         # Shared styles
  └── assets/             # Images, fonts, etc.
```

## How It Works

1. During development, assets are served directly from the Vite dev server
2. For production, assets are built locally using `npm run build`
3. Built assets are organized in a logical directory structure by section (core, home, products, etc.)
4. The `direct_asset` template tag uses multiple lookup strategies:
   - First checks manifest.json for direct entries
   - Uses section-based path patterns to locate assets
   - Falls back to predictable paths if necessary
5. Post-build processing ensures manifest.json is correctly copied from the .vite directory
6. Vendor code is chunked into separate files (bootstrap, fontawesome, etc.) for better caching

## Usage

### In Templates

Use the `direct_asset` template tag to include JavaScript and CSS files:

```html
{% load direct_assets %}

{% direct_asset "main" %}
```

This will include both the CSS and JS files for the specified asset name.

### Development Mode

When `DEBUG` is `True` and `USE_VITE_DEV_SERVER` is enabled in settings, assets will be loaded from the Vite dev server. Otherwise, they will be loaded from compiled static files.

### Debug Tools

The `debug_manifest` template tag provides information about the asset system:

```html
{% debug_manifest %}
```

There's also a view at `/asset-health/` that shows the status of your static files.

## Architecture

The system has these key components:

1. **Vite Configuration**: Defined in `frontend/vite.config.js`
2. **Django Template Tags**: Implemented in `skunkmonkey/templatetags/direct_assets.py`
3. **Build Script**: Use `build_assets.sh` to build assets locally

## Build Process

To build assets for production:

```bash
./build_assets.sh
```

This script:
1. Installs Node dependencies if needed
2. Builds assets using Vite
3. Outputs files to `/static/` directory with a `manifest.json`

## Deployment on Heroku

For Heroku deployment:
1. Build assets locally before deploying
2. Push the built assets to Heroku
3. Django's `collectstatic` will move them to the right location

## Troubleshooting

If assets aren't loading:

1. Visit `/asset-health/` to see which files are available
2. Check that manifest.json exists and has the expected entries
3. Verify that the directories like `js/core/`, `js/home/`, and respective CSS directories contain the built files
4. Check that the manifest.json is correctly copied from .vite directory during the post-build process
5. Verify that both `/static/manifest.json` and `/staticfiles/manifest.json` exist and contain identical content

## Understanding manifest.json Formats

The manifest.json file can appear in two different formats:

1. **Modern Format (from Vite):**
   ```json
   {
     "../node_modules/bootstrap/dist/js/bootstrap.esm.js": {
       "file": "js/chunks/vendor/bootstrap.B4lxJFyJ.js",
       "name": "vendor/bootstrap",
       "src": "../node_modules/bootstrap/dist/js/bootstrap.esm.js",
       "isDynamicEntry": true,
       "imports": ["_common.DLe71OcS.js"]
     },
     "_ajax_helper.aO3haSrT.js": {
       "file": "js/chunks/ajax_helper.aO3haSrT.js",
       "name": "ajax_helper",
       "imports": ["_common.DLe71OcS.js"]
     }
   }
   ```

2. **Legacy Format (simpler structure):**
   ```json
   {
     "category-filter-manager": {
       "file": "js/core/categoryFilterManager.js",
       "css": []
     },
     "filter-ui-manager": {
       "file": "js/core/filterUiManager.js",
       "css": []
     }
   }
   ```

Our asset resolution system in `direct_assets.py` handles both formats through multiple lookup strategies.
