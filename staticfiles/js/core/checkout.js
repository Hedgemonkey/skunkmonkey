document.addEventListener("DOMContentLoaded",function(){const S=document.getElementById("stripe-data");if(!S){l("Payment system initialization error. Please refresh the page or contact support.");return}const P=S.dataset.publishableKey,h=S.dataset.clientSecret,L=S.dataset.cacheUrl;if(h?F(h):sessionStorage.getItem("client_secret"),z(),!P){l("Payment system configuration error. Please contact support."),C();return}if(!h){l("Payment session could not be initialized. Please refresh the page or contact support."),C();return}const B=Stripe(P),y=document.getElementById("checkout-form"),m=document.getElementById("submit-button"),c=document.getElementById("loading-overlay"),q=document.getElementById("payment-element"),u=document.getElementById("payment-errors");if(!y||!m||!q)return;const D={clientSecret:h,appearance:{theme:"stripe",variables:{colorPrimary:"#007bff",colorBackground:"#ffffff",colorText:"#32325d",colorDanger:"#dc3545",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',spacingUnit:"4px",borderRadius:"4px"}},business:{name:"SkunkMonkey Shop"}},H=B.elements(D),x=H.create("payment",{layout:{type:"tabs",defaultCollapsed:!1},fields:{billingDetails:{address:{country:"auto"}}},terms:{card:"never"},wallets:{applePay:"auto",googlePay:"auto"}});x.mount("#payment-element");function b(){if(document.querySelector("#payment-element iframe")){const t=document.createElement("style");t.textContent=`
                #payment-element iframe {
                    margin: 0 !important;
                    width: 100% !important;
                    max-width: 100% !important;
                    min-width: 100% !important;
                    transform: none !important;
                    position: static !important;
                }
                #payment-element .__PrivateStripeElement {
                    margin: 0 !important;
                    position: relative !important;
                    transform: none !important;
                }
                .payment-element-container {
                    position: relative !important;
                    z-index: 1 !important;
                    overflow: visible !important;
                    min-height: 350px !important;
                }
            `,document.head.appendChild(t)}}b(),setTimeout(b,500),setTimeout(b,1e3),x.on("change",function(e){e.error?l(e.error.message):U(),v(),E()}),x.on("ready",function(){setTimeout(v,100),b(),setTimeout(b,100),E(),$()});let g=!1;function F(e){const t=new Date().getTime();sessionStorage.setItem("client_secret",e),sessionStorage.setItem("client_secret_timestamp",t);const n=document.querySelector(".checkout-total")||document.querySelector(".cart-total")||document.getElementById("cart-total");n&&sessionStorage.setItem("cart_total",n.textContent.trim())}function I(){sessionStorage.removeItem("client_secret"),sessionStorage.removeItem("client_secret_timestamp"),sessionStorage.removeItem("cart_total")}function z(){const e=sessionStorage.getItem("client_secret"),t=sessionStorage.getItem("client_secret_timestamp");e&&t&&new Date().getTime()-parseInt(t)>36e5&&(I(),window.location.href.includes("checkout")&&k("Your payment session has expired. Please refresh the page to continue."))}function C(){m&&(m.disabled=!0)}function l(e){u&&(u.textContent=e,u.classList.remove("d-none"))}function U(){u&&(u.textContent="",u.classList.add("d-none"))}function v(){const e=document.querySelector("#payment-element iframe"),t=document.querySelector(".payment-element-container");if(e&&t){const o=(e.scrollHeight||e.offsetHeight)+50;o>300&&(t.style.minHeight=`${o}px`)}}function $(){const e=setInterval(function(){const n=document.querySelector("#payment-element iframe");if(!n){clearInterval(e);return}const o=n.style.height||n.offsetHeight;setTimeout(function(){(n.style.height||n.offsetHeight)!==o&&(v(),E())},50)},500);setTimeout(function(){clearInterval(e)},6e4);const t=document.getElementById("payment-element");t&&(t.addEventListener("click",function(){setTimeout(function(){v(),E()},300)}),t.addEventListener("focusin",function(){setTimeout(function(){v(),E()},300)}))}function E(){const e=document.querySelector("#payment-element iframe"),t=document.querySelector(".payment-element-container"),n=document.querySelector(".stripe-element-wrapper"),o=document.getElementById("payment-element"),f=document.querySelector("#payment-element .__PrivateStripeElement");if(!e)return;function a(){const r=e.scrollHeight||e.offsetHeight||e.clientHeight||parseInt(e.style.height,10)||280;r>100&&(f&&(f.style.height=r+5+"px"),o&&(o.style.height=r+25+"px"),n&&(n.style.height=r+35+"px"),t&&(t.style.height=r+50+"px"))}a(),new MutationObserver(function(r){a()}).observe(e,{attributes:!0,attributeFilter:["style","height","class"]});const _=setInterval(a,1e3);setTimeout(()=>clearInterval(_),6e4)}function k(e="The payment session has expired. Please refresh the page to continue."){l(e);const t=document.createElement("button");t.className="btn btn-warning mt-3",t.innerText="Refresh Page",t.onclick=function(){I(),window.location.href=window.location.href.split("?")[0]+"?refresh="+new Date().getTime()},u&&!document.getElementById("refresh-button")&&(t.id="refresh-button",u.parentNode.insertBefore(t,u.nextSibling)),g=!1,m&&(m.disabled=!1),c&&(c.style.display="none")}function d(e){const t=y.elements[e]||y.elements[`id_${e}`]||document.getElementById(`id_${e}`);return t?t.value:""}function O(){const e=sessionStorage.getItem("cart_total"),t=document.querySelector(".checkout-total")||document.querySelector(".cart-total")||document.getElementById("cart-total");if(e&&t){const n=t.textContent.trim();e!==n&&I()}}y.addEventListener("submit",async function(e){var f;if(e.preventDefault(),g)return;const t=document.getElementById("terms-check");if(!t||!t.checked){l("Please agree to the terms and conditions.");return}g=!0,m.disabled=!0;const n=document.getElementById("button-text"),o=document.getElementById("spinner");n&&n.classList.add("d-none"),o&&o.classList.remove("d-none"),c&&(c.style.display="flex");try{const a=y.querySelector('input[name="csrfmiddlewaretoken"]');if(!a)throw new Error("CSRF token not found in form");const T=a.value,_=new FormData;_.append("client_secret",h),_.append("save_info",((f=document.getElementById("id_save_payment_info"))==null?void 0:f.checked)||!1);try{const s=await fetch(L,{method:"POST",headers:{"X-CSRFToken":T},body:_});let i;try{i=await s.json()}catch(w){console.error("Failed to parse response JSON:",w),i={}}if(s.status===409&&i.error==="payment_intent_unexpected_state"){k(i.message||"The payment session has expired. Please refresh the page to continue.");return}if(!s.ok){console.error("Server error:",i),l(i.error||"An error occurred. Please try again."),g=!1,m.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),c&&(c.style.display="none");return}}catch(s){console.error("Error during fetch operation:",s),l("Network error. Please check your connection and try again."),g=!1,m.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),c&&(c.style.display="none");return}let r;try{let s=window.location.origin;s.endsWith("/")||(s+="/");let i=y.action;if(i.startsWith("/")||!i.includes("://"))if(i.startsWith("/"))r=s+i.substring(1).replace("checkout","checkout/success");else{const w=window.location.pathname,M=w.substring(0,w.lastIndexOf("/")+1);r=s+M+i.replace("checkout","checkout/success")}else r=i.replace("checkout","checkout/success");if(r=r.replace(/([^:])\/\//g,"$1/"),!r.startsWith("http"))throw new Error("Return URL is not absolute: "+r);r.endsWith("//")&&(r=r.slice(0,-1))}catch(s){console.error("Error constructing return URL:",s),r=window.location.origin+"/shop/checkout/success/"}const A=R(),{error:p}=await B.confirmPayment({elements:H,confirmParams:{return_url:r,shipping:A,receipt_email:d("email")},redirect:"if_required"});if(p)p.type==="card_error"||p.type==="validation_error"?l(p.message):p.type==="invalid_request_error"&&(p.code==="payment_intent_unexpected_state"||p.message.includes("is not available")||p.message.includes("payment_intent"))?(I(),k("The payment session has expired. Please refresh the page to continue.")):(l("An unexpected error occurred."),console.error("Payment error:",p)),g=!1,m.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),c&&(c.style.display="none");else{const s=document.getElementById("id_payment_intent_id");s&&h&&(s.value=h.split("_secret")[0]);const i=document.getElementById("id_payment_method_type");i&&(i.value="card"),I(),y.submit()}}catch(a){console.error("Error in checkout process:",a),l(a.message||"An unexpected error occurred. Please try again."),g=!1,m.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),c&&(c.style.display="none")}});function R(){return{name:`${d("shipping_first_name")} ${d("shipping_last_name")}`.trim(),address:{line1:d("shipping_address1"),line2:d("shipping_address2")||void 0,city:d("shipping_city"),state:d("shipping_state"),postal_code:d("shipping_zipcode"),country:d("shipping_country")||"US"}}}[{source:"first_name",target:"shipping_first_name"},{source:"last_name",target:"shipping_last_name"}].forEach(e=>{const t=document.getElementById(`id_${e.source}`),n=document.getElementById(`id_${e.target}`);t&&n&&t.addEventListener("change",function(){n.value||(n.value=t.value)})}),O(),window.addEventListener("resize",function(){clearTimeout(window.resizeTimer),window.resizeTimer=setTimeout(function(){v(),E()},200)}),console.log("Checkout script with Payment Element initialization complete")});
