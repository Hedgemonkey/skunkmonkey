import{$ as s}from"../chunks/chunks/vendor/common.Dz0GDR6V.js";import{a as r}from"../common/apiClient.js";import{n as a}from"./notifications.js";import{s as o}from"./formUtils.js";import{C as l}from"./categoryFilterManager.js";import{F as c}from"./filterUiManager.js";import"../chunks/ajax_helper.EulIYOr7.js";import"./arrayUtils.js";class R{constructor(e){this.containerId=e.containerId,this.filterUrl=e.filterUrl,this.onUpdate=e.onUpdate||function(){},this.searchDelay=e.searchDelay||300,this.itemType=e.itemType||"products",this.filterOnCategorySelect=e.filterOnCategorySelect!==void 0?e.filterOnCategorySelect:!0,this.container=s(`#${this.containerId}`),this.searchTimeout=null,this.pendingRequest=null,this.lastFilteredValue="",this.categoryManager=new l(this),this.uiManager=new c(this),this._initialize()}_initialize(){this.categoryManager.initialize(),this.uiManager.initialize(),this._initializeEventListeners(),this.filterItems()}_initializeEventListeners(){this._setupSearchEvents(),this._setupSortEvents(),this._setupResetEvents(),this._setupListProductsEvent()}_setupSearchEvents(){this.container.on("input",".filter-search",this._handleSearchInput.bind(this)),this.container.on("click",".clear-search",this._handleClearSearch.bind(this))}_handleSearchInput(e){const i=s(e.currentTarget).val();i!==this.lastFilteredValue&&(clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.lastFilteredValue=i,this.filterItems()},this.searchDelay))}_handleClearSearch(){this.container.find(".filter-search").val(""),this.lastFilteredValue="",this.filterItems()}_setupSortEvents(){this.container.on("change",".filter-sort",()=>{this.filterItems()})}_setupResetEvents(){this.container.on("click",".reset-all-filters",()=>{const e=this.container.find(".clear-search"),t=this.container.find(".clear-categories-btn");e.length&&e.click(),t.length&&t.click()})}_setupListProductsEvent(){this.container.on("click",".list-products-btn",()=>{const e=this.categoryManager.getSelectedCategories();e.length>0?(window.location.href=`/products/staff/management/?category=${e.join(",")}`,setTimeout(()=>{s("#product-list-section").addClass("show"),s("#products-header button").attr("aria-expanded","true").removeClass("collapsed"),s("html, body").animate({scrollTop:s("#products-header").offset().top-100},500)},300)):a.displayWarning("Please select at least one category first.")})}filterItems(){this._cancelPendingRequest();const e=this._buildRequestParams();this.uiManager.updateFilterSummary(),this._showLoading(!0);const t=this._captureSearchFieldState();this._makeFilterRequest(e,t)}_cancelPendingRequest(){this.pendingRequest&&(r.pendingRequests&&r.pendingRequests.includes(this.pendingRequest)?(r.removePendingRequest(this.pendingRequest),typeof this.pendingRequest.abort=="function"&&this.pendingRequest.abort()):typeof this.pendingRequest.abort=="function"&&this.pendingRequest.abort(),this.pendingRequest=null)}_buildRequestParams(){const e=this.container.find(".filter-search").val(),i=this.categoryManager.getSelectedCategories().join(","),n={search:e,sort:this.container.find(".filter-sort").val(),items_only:!0};return i&&this.itemType!=="categories"&&(n.category=i),console.log(`Building filter params for ${this.itemType}:`,n),n}_captureSearchFieldState(){const e=this.container.find(".filter-search"),t=document.activeElement===e[0];return{field:e,wasFocused:t,selectionStart:t?e[0].selectionStart:null,selectionEnd:t?e[0].selectionEnd:null}}_makeFilterRequest(e,t){this.pendingRequest=r.get(this.filterUrl,e,{skipGlobalErrorHandler:!0}).then(i=>{this._handleFilterSuccess(i,t)}).catch(i=>{this._handleFilterError(i,t)}).finally(()=>{this.pendingRequest=null})}_handleFilterSuccess(e,t){try{this._processSuccessfulResponse(e)}catch(i){console.error("Error processing filter results:",i)}finally{this._finishFilterRequest(t)}}_handleFilterError(e,t){e.statusText!=="abort"&&(console.error(`Error fetching ${this.itemType}:`,e),a.displayError(`Failed to filter ${this.itemType}. Please try again.`)),this._finishFilterRequest(t)}_finishFilterRequest(e){this._showLoading(!1),e.wasFocused&&(e.field.focus(),e.selectionStart!==null&&e.selectionEnd!==null&&e.field[0].setSelectionRange(e.selectionStart,e.selectionEnd))}_processSuccessfulResponse(e){let t;this.itemType==="categories"?(t=s("#category-cards-grid"),t.length||(t=this.container.find("#category-cards-grid")),t.length||(t=this.container.find(".filtered-items"))):(t=s("#product-cards-grid"),t.length||(t=this.container.find("#product-cards-grid")),t.length||(t=this.container.find(".filtered-items"))),t.length||(console.warn(`Could not find specific container for ${this.itemType}, using main container`),t=this.container),e.html?(t.html(e.html),console.log(`Updated ${this.itemType} HTML content from response.html`)):typeof e=="string"?(t.html(e),console.log(`Updated ${this.itemType} HTML content from string response`)):console.warn(`No HTML content found in response for ${this.itemType}`);const i=this._extractItemCount(e,t);this.uiManager.updateItemCountDisplays(i),typeof this.onUpdate=="function"&&this.onUpdate(e),console.log(`Updated ${this.itemType} container with new content. Count: ${i}`)}_extractItemCount(e,t){return e.count!==void 0?e.count:e.total_count!==void 0?e.total_count:this._countItemsInContainer(t)}_countItemsInContainer(e){const t=[".card",".item",".product-card",".category-card"];for(const i of t){const n=e.find(i).length;if(n>0)return n}return 0}_showLoading(e){o(this.container,".filter-sort",e),this.container.find(".filter-loading").toggleClass("loading",e)}preloadCategories(){this.categoryManager.applySavedCategories()}destroy(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.pendingRequest&&this.pendingRequest.abort(),this.container.off("input",".filter-search"),this.container.off("click",".clear-search"),this.container.off("change",".filter-sort"),this.container.off("click",".reset-all-filters"),this.container.off("click",".list-products-btn"),this.categoryManager.destroy(),this.uiManager.destroy()}}export{R as I};
