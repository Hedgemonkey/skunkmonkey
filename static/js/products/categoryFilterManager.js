import{a as g}from"./formUtils.js";import{r as a}from"./arrayUtils.js";import{$ as i}from"../chunks/chunks/vendor/common.Dz0GDR6V.js";class p{constructor(e){this.filter=e,this.container=e.container,this.selectedCategories=this._getSavedCategories()||[]}initialize(){this._initializeSelect2(),this._setupCategoryEvents(),this._renderCategoryTags(),this._updateCategoryCardStyling(),this.selectedCategories.length>0&&this.filter.itemType==="categories"&&this.filter.uiManager._updateProductCount()}_initializeSelect2(){const e=this.container.find(".filter-category");e.length&&(g(e,{url:"/products/api/categories/search/",formatResult:t=>this._formatCategoryOption(t),multiple:!0,allowClear:!0,placeholder:"Select or search categories"}),this._setupCheckboxHandlers(),e.on("select2:open",()=>{setTimeout(()=>{this._updateDropdownCheckboxes()},50)}))}_formatCategoryOption(e){if(!e.id)return e.text;const t=this.selectedCategories.includes(e.id.toString());return i(`
            <div class="select2-result-category">
                <input type="checkbox" class="form-check-input me-2" id="category-${e.id}"
                       ${t?"checked":""}>
                <label for="category-${e.id}">${e.text}</label>
            </div>
        `)}_updateDropdownCheckboxes(){i('.select2-results__options .select2-result-category input[type="checkbox"]').each((e,t)=>{const r=i(t),s=r.attr("id").replace("category-",""),o=this.selectedCategories.includes(s);r.prop("checked",o)})}_setupCheckboxHandlers(){i(document).off("click",'.select2-result-category input[type="checkbox"]').on("click",'.select2-result-category input[type="checkbox"]',e=>{e.stopPropagation();const t=i(e.currentTarget),r=t.attr("id").replace("category-",""),s=this.container.find(".filter-category");let c=[...s.val()||[]];t.is(":checked")&&!c.includes(r)?c.push(r):t.is(":checked")||(c=a(c,r)),s.val(c).trigger("change")})}_setupCategoryEvents(){const e=this.container.find(".filter-category");e.length&&(e.on("change",()=>{const t=e.val()||[];this.selectedCategories=t.map(r=>r.toString()),this._saveCategories(this.selectedCategories),this.container.find(".category-count").text(this.selectedCategories.length),this._renderCategoryTags(),this._updateCategoryCardStyling(),this.filter.uiManager.updateFilterSummary(),this.filter.itemType==="products"?this.filter.filterItems():this.filter.filterOnCategorySelect&&this.filter.filterItems()}),this.container.on("click",".clear-categories-btn",()=>{e.val([]).trigger("change"),this._saveCategories([]),this.container.find(".category-count").text("0"),this._renderCategoryTags(),this.filter.uiManager.updateFilterSummary(),this.filter.itemType==="products"?this.filter.filterItems():this.filter.filterOnCategorySelect&&this.filter.filterItems()}),i(document).off("click",".category-header").on("click",".category-header",t=>{if(!i(t.target).closest("button, a").length){const r=i(t.currentTarget).data("category-id");if(r)return this._toggleCategory(r.toString()),!1}}))}_toggleCategory(e){console.log("Toggling category:",e);const t=this.container.find(".filter-category");if(!t.length)return;let s=[...t.val()||[]];s.includes(e)?s=a(s,e):s.push(e),t.val(s).trigger("change");try{t.trigger("change.select2"),i(".select2-results__options").is(":visible")&&this._updateDropdownCheckboxes()}catch(o){console.warn("Error triggering Select2 change:",o)}}_updateCategoryCardStyling(){i(".category-header").removeClass("bg-primary text-white selected").addClass("bg-light"),this.selectedCategories.forEach(e=>{i(`.category-header[data-category-id="${e}"]`).removeClass("bg-light").addClass("bg-primary text-white selected")})}_renderCategoryTags(){const e=this.container.find(".selected-categories-tags");if(!e.length)return;if(e.empty(),!this.selectedCategories.length){e.hide();return}const t=this.container.find(".filter-category");Array.from(t.find("option:selected")).forEach(s=>{const o=i(s).val(),c=i(s).text(),n=i(`
                <span class="badge bg-primary me-1 mb-1 category-tag" data-category-id="${o}">
                    ${c}
                    <button type="button" class="btn-close btn-close-white ms-1" aria-label="Remove"></button>
                </span>
            `);n.find(".btn-close").on("click",l=>{l.preventDefault(),l.stopPropagation(),this.removeCategory(o)}),e.append(n)}),e.show()}removeCategory(e){const t=this.container.find(".filter-category"),r=t.val()||[],s=a(r,e);t.val(s).trigger("change")}_saveCategories(e){const t=e.map(r=>r.toString());this.selectedCategories=t,localStorage.setItem("selectedCategories",JSON.stringify(t))}_getSavedCategories(){const e=localStorage.getItem("selectedCategories");return e?JSON.parse(e):[]}applySavedCategories(){const e=this._getSavedCategories();if(!e||e.length===0)return;const t=this.container.find(".filter-category");t.val(e);try{t.trigger("change.select2"),i(".select2-results__options").is(":visible")&&this._updateDropdownCheckboxes()}catch(r){console.warn("Error triggering Select2 change:",r),t.trigger("change")}this.container.find(".category-count").text(e.length),this._renderCategoryTags(),e.length>0&&this.filter.itemType==="categories"&&this.filter.uiManager._updateProductCount(),this.filter.itemType==="products"&&e.length>0&&this.filter.filterItems()}getSelectedCategories(){return this.selectedCategories}destroy(){const e=this.container.find(".filter-category");if(this.container.off("click",".clear-categories-btn"),e.off("change"),e.off("select2:open"),i(document).off("click",".category-header"),e.length&&i.fn.select2)try{e.select2("destroy")}catch(t){console.warn("Error destroying Select2:",t)}i(document).off("click",'.select2-result-category input[type="checkbox"]'),this.container.find(".selected-categories-tags .btn-close").off("click")}}export{p as C};
