document.addEventListener("DOMContentLoaded",function(){let y=!1;function L(e){const t=new Date().getTime();sessionStorage.setItem("client_secret",e),sessionStorage.setItem("client_secret_timestamp",t);const n=document.querySelector(".checkout-total")||document.querySelector(".cart-total")||document.getElementById("cart-total");n&&sessionStorage.setItem("cart_total",n.textContent.trim())}function _(){sessionStorage.removeItem("client_secret"),sessionStorage.removeItem("client_secret_timestamp"),sessionStorage.removeItem("cart_total")}function C(){const e=sessionStorage.getItem("client_secret"),t=sessionStorage.getItem("client_secret_timestamp");e&&t&&new Date().getTime()-parseInt(t)>36e5&&(_(),window.location.href.includes("checkout")&&x("Your payment session has expired. Please refresh the page to continue."))}function B(){const e=document.getElementById("submit-button");e&&(e.disabled=!0)}function a(e){const t=document.getElementById("payment-errors");t&&(t.textContent=e,t.classList.remove("d-none"))}function D(){const e=document.getElementById("payment-errors");e&&(e.textContent="",e.classList.add("d-none"))}function x(e="The payment session has expired. Please refresh the page to continue."){a(e);const t=document.createElement("button");t.className="btn btn-warning mt-3",t.innerText="Refresh Page",t.onclick=function(){_(),window.location.href=window.location.href.split("?")[0]+"?refresh="+new Date().getTime()};const n=document.getElementById("payment-errors");n&&!document.getElementById("refresh-button")&&(t.id="refresh-button",n.parentNode.insertBefore(t,n.nextSibling)),y=!1;const o=document.getElementById("submit-button"),c=document.getElementById("loading-overlay");o&&(o.disabled=!1),c&&(c.style.display="none")}const I=document.getElementById("stripe-data");if(!I){a("Payment system initialization error. Please refresh the page or contact support.");return}const k=I.dataset.publishableKey,h=I.dataset.clientSecret,q=I.dataset.cacheUrl;if(h&&L(h),C(),!k){a("Payment system configuration error. Please contact support."),B();return}if(!h){a("Payment session could not be initialized. Please refresh the page or contact support."),B();return}const P=Stripe(k),g=document.getElementById("checkout-form"),E=document.getElementById("submit-button"),l=document.getElementById("loading-overlay"),F=document.getElementById("payment-element");if(!g||!E||!F)return;const z={clientSecret:h,appearance:{theme:"stripe",variables:{colorPrimary:"#007bff",colorBackground:"#ffffff",colorText:"#32325d",colorDanger:"#dc3545",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',spacingUnit:"4px",borderRadius:"4px"}}},H=P.elements(z),T=H.create("payment",{layout:{type:"tabs",defaultCollapsed:!1},fields:{billingDetails:{address:{country:"auto"}}},terms:{card:"never"},wallets:{applePay:"auto",googlePay:"auto"}});T.mount("#payment-element");function w(){if(document.querySelector("#payment-element iframe")){const t=document.createElement("style");t.textContent=`
                #payment-element iframe {
                    margin: 0 !important;
                    width: 100% !important;
                    max-width: 100% !important;
                    min-width: 100% !important;
                    transform: none !important;
                    position: static !important;
                }
                #payment-element .__PrivateStripeElement {
                    margin: 0 !important;
                    position: relative !important;
                    transform: none !important;
                }
                .payment-element-container {
                    position: relative !important;
                    z-index: 1 !important;
                    overflow: visible !important;
                    min-height: 350px !important;
                }
            `,document.head.appendChild(t)}}w(),setTimeout(w,500),setTimeout(w,1e3),T.on("change",function(e){e.error?a(e.error.message):D(),f(),p()}),T.on("ready",function(){setTimeout(f,100),w(),setTimeout(w,100),p(),U()}),window.addEventListener("resize",function(){setTimeout(function(){f(),p()},100)}),window.addEventListener("orientationchange",function(){setTimeout(function(){f(),p()},300)});function f(){const e=document.querySelector("#payment-element iframe"),t=document.querySelector(".payment-element-container");if(e&&t){const n=window.innerWidth<=767.98,o=window.innerWidth<=575.98,c=window.innerWidth<=375;if(n)c?(e.style.minHeight="700px",t.style.minHeight="720px"):o?(e.style.minHeight="650px",t.style.minHeight="670px"):(e.style.minHeight="600px",t.style.minHeight="620px"),t.style.height="auto",t.style.overflow="visible";else{const v=(e.scrollHeight||e.offsetHeight)+50;v>300&&(t.style.minHeight=`${v}px`)}}}function U(){const e=setInterval(function(){const n=document.querySelector("#payment-element iframe");if(!n){clearInterval(e);return}const o=n.style.height||n.offsetHeight;setTimeout(function(){(n.style.height||n.offsetHeight)!==o&&(f(),p())},50)},500);setTimeout(function(){clearInterval(e)},6e4);const t=document.getElementById("payment-element");t&&(t.addEventListener("click",function(){setTimeout(function(){f(),p()},300)}),t.addEventListener("focusin",function(){setTimeout(function(){f(),p()},300)}))}function p(){const e=document.querySelector("#payment-element iframe"),t=document.querySelector(".payment-element-container"),n=document.querySelector(".stripe-element-wrapper"),o=document.getElementById("payment-element"),c=document.querySelector("#payment-element .__PrivateStripeElement");if(!e)return;function m(){const i=e.scrollHeight||e.offsetHeight||e.clientHeight||parseInt(e.style.height,10)||280;i>100&&(c&&(c.style.height=i+5+"px"),o&&(o.style.height=i+25+"px"),n&&(n.style.height=i+35+"px"),t&&(t.style.height=i+50+"px"))}m(),new MutationObserver(function(){m()}).observe(e,{attributes:!0,attributeFilter:["style","height","class"]});const b=setInterval(m,1e3);setTimeout(()=>clearInterval(b),6e4)}function d(e){const t=g.elements[e]||g.elements[`id_${e}`]||document.getElementById(`id_${e}`);return t?t.value:""}function W(){const e=sessionStorage.getItem("cart_total"),t=document.querySelector(".checkout-total")||document.querySelector(".cart-total")||document.getElementById("cart-total");if(e&&t){const n=t.textContent.trim();e!==n&&_()}}g.addEventListener("submit",async function(e){var c;if(e.preventDefault(),y)return;const t=document.getElementById("terms-check");if(!t||!t.checked){a("Please agree to the terms and conditions.");return}y=!0,E.disabled=!0;const n=document.getElementById("button-text"),o=document.getElementById("spinner");n&&n.classList.add("d-none"),o&&o.classList.remove("d-none"),l&&(l.style.display="flex");try{const m=g.querySelector('input[name="csrfmiddlewaretoken"]');if(!m)throw new Error("CSRF token not found in form");const v=m.value,b=new FormData;b.append("client_secret",h),b.append("save_info",((c=document.getElementById("id_save_payment_info"))==null?void 0:c.checked)||!1);try{const s=await fetch(q,{method:"POST",headers:{"X-CSRFToken":v},body:b});let r;try{r=await s.json()}catch(S){console.error("Failed to parse response JSON:",S),r={}}if(s.status===409&&r.error==="payment_intent_unexpected_state"){x(r.message||"The payment session has expired. Please refresh the page to continue.");return}if(!s.ok){console.error("Server error:",r),a(r.error||"An error occurred. Please try again."),y=!1,E.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),l&&(l.style.display="none");return}}catch(s){console.error("Error during fetch operation:",s),a("Network error. Please check your connection and try again."),y=!1,E.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),l&&(l.style.display="none");return}let i;try{let s=window.location.origin;s.endsWith("/")||(s+="/");let r=g.action;if(r.startsWith("/")||!r.includes("://"))if(r.startsWith("/"))i=s+r.substring(1).replace("checkout","checkout/success");else{const S=window.location.pathname,R=S.substring(0,S.lastIndexOf("/")+1);i=s+R+r.replace("checkout","checkout/success")}else i=r.replace("checkout","checkout/success");if(i=i.replace(/([^:])\/\//g,"$1/"),!i.startsWith("http"))throw new Error("Return URL is not absolute: "+i);i.endsWith("//")&&(i=i.slice(0,-1))}catch(s){console.error("Error constructing return URL:",s),i=window.location.origin+"/shop/checkout/success/"}const O=$(),{error:u}=await P.confirmPayment({elements:H,confirmParams:{return_url:i,shipping:O,receipt_email:d("email")},redirect:"if_required"});if(u)u.type==="card_error"||u.type==="validation_error"?a(u.message):u.type==="invalid_request_error"&&(u.code==="payment_intent_unexpected_state"||u.message.includes("is not available")||u.message.includes("payment_intent"))?(_(),x("The payment session has expired. Please refresh the page to continue.")):(a("An unexpected error occurred."),console.error("Payment error:",u)),y=!1,E.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),l&&(l.style.display="none");else{const s=document.getElementById("id_payment_intent_id");s&&h&&(s.value=h.split("_secret")[0]);const r=document.getElementById("id_payment_method_type");r&&(r.value="card"),_(),g.submit()}}catch(m){console.error("Error in checkout process:",m),a(m.message||"An unexpected error occurred. Please try again."),y=!1,E.disabled=!1,n&&n.classList.remove("d-none"),o&&o.classList.add("d-none"),l&&(l.style.display="none")}});function $(){return{name:`${d("shipping_first_name")} ${d("shipping_last_name")}`.trim(),address:{line1:d("shipping_address1"),line2:d("shipping_address2")||void 0,city:d("shipping_city"),state:d("shipping_state"),postal_code:d("shipping_zipcode"),country:d("shipping_country")||"US"}}}[{source:"first_name",target:"shipping_first_name"},{source:"last_name",target:"shipping_last_name"}].forEach(e=>{const t=document.getElementById(`id_${e.source}`),n=document.getElementById(`id_${e.target}`);t&&n&&t.addEventListener("change",function(){n.value||(n.value=t.value)})}),W(),window.addEventListener("resize",function(){clearTimeout(window.resizeTimer),window.resizeTimer=setTimeout(function(){f(),p()},200)}),console.log("Checkout script with Payment Element initialization complete")});
