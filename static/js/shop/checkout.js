document.addEventListener("DOMContentLoaded",function(){let y=!1;function C(e){const t=new Date().getTime();sessionStorage.setItem("client_secret",e),sessionStorage.setItem("client_secret_timestamp",t);const n=document.querySelector(".checkout-total")||document.querySelector(".cart-total")||document.getElementById("cart-total");n&&sessionStorage.setItem("cart_total",n.textContent.trim())}function _(){sessionStorage.removeItem("client_secret"),sessionStorage.removeItem("client_secret_timestamp"),sessionStorage.removeItem("cart_total")}function q(){const e=sessionStorage.getItem("client_secret"),t=sessionStorage.getItem("client_secret_timestamp");e&&t&&new Date().getTime()-parseInt(t)>36e5&&(_(),window.location.href.includes("checkout")&&x("Your payment session has expired. Please refresh the page to continue."))}function T(){const e=document.getElementById("submit-button");e&&(e.disabled=!0)}function m(e){const t=document.getElementById("payment-errors");t&&(t.textContent=e,t.classList.remove("d-none"))}function D(){const e=document.getElementById("payment-errors");e&&(e.textContent="",e.classList.add("d-none"))}function x(e="The payment session has expired. Please refresh the page to continue."){m(e);const t=document.createElement("button");t.className="btn btn-warning mt-3",t.innerText="Refresh Page",t.onclick=function(){_(),window.location.href=window.location.href.split("?")[0]+"?refresh="+new Date().getTime()};const n=document.getElementById("payment-errors");n&&!document.getElementById("refresh-button")&&(t.id="refresh-button",n.parentNode.insertBefore(t,n.nextSibling)),y=!1;const i=document.getElementById("submit-button"),a=document.getElementById("loading-overlay");i&&(i.disabled=!1),a&&(a.style.display="none")}const S=document.getElementById("stripe-data");if(!S){m("Payment system initialization error. Please refresh the page or contact support.");return}const B=S.dataset.publishableKey,g=S.dataset.clientSecret,F=S.dataset.cacheUrl;if(g?C(g):sessionStorage.getItem("client_secret"),q(),!B){m("Payment system configuration error. Please contact support."),T();return}if(!g){m("Payment session could not be initialized. Please refresh the page or contact support."),T();return}const k=Stripe(B),E=document.getElementById("checkout-form"),b=document.getElementById("submit-button"),d=document.getElementById("loading-overlay"),M=document.getElementById("payment-element");if(document.getElementById("payment-errors"),!E||!b||!M)return;const W={clientSecret:g,appearance:{theme:"stripe",variables:{colorPrimary:"#007bff",colorBackground:"#ffffff",colorText:"#32325d",colorDanger:"#dc3545",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',spacingUnit:"4px",borderRadius:"4px"}}},P=k.elements(W),H=P.create("payment",{layout:{type:"tabs",defaultCollapsed:!1},fields:{billingDetails:{address:{country:"auto"}}},terms:{card:"never"},wallets:{applePay:"auto",googlePay:"auto"}});H.mount("#payment-element");function I(){if(document.querySelector("#payment-element iframe")){const t=document.createElement("style");t.textContent=`
                #payment-element iframe {
                    margin: 0 !important;
                    width: 100% !important;
                    max-width: 100% !important;
                    min-width: 100% !important;
                    transform: none !important;
                    position: static !important;
                }
                #payment-element .__PrivateStripeElement {
                    margin: 0 !important;
                    position: relative !important;
                    transform: none !important;
                }
                .payment-element-container {
                    position: relative !important;
                    z-index: 1 !important;
                    overflow: visible !important;
                    min-height: 350px !important;
                }
            `,document.head.appendChild(t)}}I(),setTimeout(I,500),setTimeout(I,1e3),H.on("change",function(e){e.error?m(e.error.message):D(),h(),f()}),H.on("ready",function(){setTimeout(h,100),I(),setTimeout(I,100),f(),z()}),window.addEventListener("resize",function(){setTimeout(function(){h(),f()},100)}),window.addEventListener("orientationchange",function(){setTimeout(function(){h(),f()},300)});function h(){const e=document.querySelector("#payment-element iframe"),t=document.querySelector(".payment-element-container");if(e&&t){const n=window.innerWidth<=767.98,i=window.innerWidth<=575.98,a=window.innerWidth<=375;if(n)a?(e.style.minHeight="700px",t.style.minHeight="720px"):i?(e.style.minHeight="650px",t.style.minHeight="670px"):(e.style.minHeight="600px",t.style.minHeight="620px"),t.style.height="auto",t.style.overflow="visible";else{const v=(e.scrollHeight||e.offsetHeight)+50;v>300&&(t.style.minHeight=`${v}px`)}}}function z(){const e=setInterval(function(){const n=document.querySelector("#payment-element iframe");if(!n){clearInterval(e);return}const i=n.style.height||n.offsetHeight;setTimeout(function(){(n.style.height||n.offsetHeight)!==i&&(h(),f())},50)},500);setTimeout(function(){clearInterval(e)},6e4);const t=document.getElementById("payment-element");t&&(t.addEventListener("click",function(){setTimeout(function(){h(),f()},300)}),t.addEventListener("focusin",function(){setTimeout(function(){h(),f()},300)}))}function f(){const e=document.querySelector("#payment-element iframe"),t=document.querySelector(".payment-element-container"),n=document.querySelector(".stripe-element-wrapper"),i=document.getElementById("payment-element"),a=document.querySelector("#payment-element .__PrivateStripeElement");if(!e)return;function c(){const o=e.scrollHeight||e.offsetHeight||e.clientHeight||parseInt(e.style.height,10)||280;o>100&&(a&&(a.style.height=o+5+"px"),i&&(i.style.height=o+25+"px"),n&&(n.style.height=o+35+"px"),t&&(t.style.height=o+50+"px"))}c(),new MutationObserver(function(o){c()}).observe(e,{attributes:!0,attributeFilter:["style","height","class"]});const w=setInterval(c,1e3);setTimeout(()=>clearInterval(w),6e4)}function p(e){const t=E.elements[e]||E.elements[`id_${e}`]||document.getElementById(`id_${e}`);return t?t.value:""}function O(){const e=sessionStorage.getItem("cart_total"),t=document.querySelector(".checkout-total")||document.querySelector(".cart-total")||document.getElementById("cart-total");if(e&&t){const n=t.textContent.trim();e!==n&&_()}}E.addEventListener("submit",async function(e){var a;if(e.preventDefault(),y)return;const t=document.getElementById("terms-check");if(!t||!t.checked){m("Please agree to the terms and conditions.");return}y=!0,b.disabled=!0;const n=document.getElementById("button-text"),i=document.getElementById("spinner");n&&n.classList.add("d-none"),i&&i.classList.remove("d-none"),d&&(d.style.display="flex");try{const c=E.querySelector('input[name="csrfmiddlewaretoken"]');if(!c)throw new Error("CSRF token not found in form");const v=c.value,w=new FormData;w.append("client_secret",g),w.append("save_info",((a=document.getElementById("id_save_payment_info"))==null?void 0:a.checked)||!1);try{const r=await fetch(F,{method:"POST",headers:{"X-CSRFToken":v},body:w});let s;try{s=await r.json()}catch(l){console.error("Failed to parse response JSON:",l),s={}}if(r.status===409&&s.error==="payment_intent_unexpected_state"){x(s.message||"The payment session has expired. Please refresh the page to continue.");return}if(!r.ok){console.error("Server error:",s),m(s.error||"An error occurred. Please try again."),y=!1,b.disabled=!1,n&&n.classList.remove("d-none"),i&&i.classList.add("d-none"),d&&(d.style.display="none");return}}catch(r){console.error("Error during fetch operation:",r),m("Network error. Please check your connection and try again."),y=!1,b.disabled=!1,n&&n.classList.remove("d-none"),i&&i.classList.add("d-none"),d&&(d.style.display="none");return}let o;try{let r=window.location.origin;r.endsWith("/")||(r+="/");let s=E.action;if(s.startsWith("/")||!s.includes("://"))if(s.startsWith("/"))o=r+s.substring(1).replace("checkout","checkout/success");else{const l=window.location.pathname,$=l.substring(0,l.lastIndexOf("/")+1);o=r+$+s.replace("checkout","checkout/success")}else o=s.replace("checkout","checkout/success");if(o=o.replace(/([^:])\/\//g,"$1/"),!o.startsWith("http"))throw new Error("Return URL is not absolute: "+o);o.endsWith("//")&&(o=o.slice(0,-1))}catch(r){console.error("Error constructing return URL:",r),o=window.location.origin+"/shop/checkout/success/"}const L=U(),{error:u}=await k.confirmPayment({elements:P,confirmParams:{return_url:o,shipping:L,receipt_email:p("email")},redirect:"if_required"});if(u)u.type==="card_error"||u.type==="validation_error"?m(u.message):u.type==="invalid_request_error"&&(u.code==="payment_intent_unexpected_state"||u.message.includes("is not available")||u.message.includes("payment_intent"))?(_(),x("The payment session has expired. Please refresh the page to continue.")):(m("An unexpected error occurred."),console.error("Payment error:",u)),y=!1,b.disabled=!1,n&&n.classList.remove("d-none"),i&&i.classList.add("d-none"),d&&(d.style.display="none");else{const r=document.getElementById("id_payment_intent_id");r&&g&&(r.value=g.split("_secret")[0]);const s=document.getElementById("id_payment_method_type");s&&(s.value="card"),_(),E.submit()}}catch(c){console.error("Error in checkout process:",c),m(c.message||"An unexpected error occurred. Please try again."),y=!1,b.disabled=!1,n&&n.classList.remove("d-none"),i&&i.classList.add("d-none"),d&&(d.style.display="none")}});function U(){return{name:`${p("shipping_first_name")} ${p("shipping_last_name")}`.trim(),address:{line1:p("shipping_address1"),line2:p("shipping_address2")||void 0,city:p("shipping_city"),state:p("shipping_state"),postal_code:p("shipping_zipcode"),country:p("shipping_country")||"US"}}}[{source:"first_name",target:"shipping_first_name"},{source:"last_name",target:"shipping_last_name"}].forEach(e=>{const t=document.getElementById(`id_${e.source}`),n=document.getElementById(`id_${e.target}`);t&&n&&t.addEventListener("change",function(){n.value||(n.value=t.value)})}),O(),window.addEventListener("resize",function(){clearTimeout(window.resizeTimer),window.resizeTimer=setTimeout(function(){h(),f()},200)}),console.log("Checkout script with Payment Element initialization complete")});
