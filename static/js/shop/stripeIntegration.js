class c{constructor(){this.stripe=null,this.elements=null,this.card=null,this.form=null,this.cardElement=null,this.cardErrors=null,this.submitButton=null,this.publishableKey=null,this.clientSecret=null,this.orderCompleteUrl=null,this.loadStripeJs().then(()=>{this.init()}).catch(e=>{console.error("Error loading Stripe.js:",e)})}loadStripeJs(){return new Promise((e,t)=>{if(window.Stripe){e(window.Stripe);return}const n=document.createElement("script");n.src="https://js.stripe.com/v3/",n.onload=()=>e(window.Stripe),n.onerror=()=>t(new Error("Failed to load Stripe.js")),document.head.appendChild(n)})}init(){var e,t,n,i;if(this.publishableKey=((e=document.getElementById("stripe_public_key"))==null?void 0:e.value)||((t=document.getElementById("id_stripe_public_key"))==null?void 0:t.value),this.clientSecret=(n=document.getElementById("client_secret"))==null?void 0:n.value,this.orderCompleteUrl=(i=document.getElementById("order_complete_url"))==null?void 0:i.value,!this.publishableKey){console.error("Stripe publishable key not found");return}console.log("Initializing Stripe with key:",this.publishableKey),this.stripe=window.Stripe(this.publishableKey),this.elements=this.stripe.elements(),window.location.pathname.includes("checkout")?this.initializeCheckout():window.location.pathname.includes("payment")?this.initializePayment():window.location.pathname.includes("payment_methods")&&this.initializePaymentMethods()}initializeCheckout(){if(this.form=document.getElementById("checkout-form"),this.cardElement=document.getElementById("card-element"),this.cardErrors=document.getElementById("card-errors"),this.submitButton=document.getElementById("submit-button"),!this.form||!this.cardElement){console.warn("Required checkout elements not found");return}const e={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#dc3545",iconColor:"#dc3545"}};this.card=this.elements.create("card",{style:e}),this.card.mount(this.cardElement),this.form.addEventListener("submit",this.handleCheckoutSubmit.bind(this))}handleCheckoutSubmit(e){e.preventDefault(),this.setLoading(!0);const t=new FormData(this.form),n={name:t.get("full_name"),email:t.get("email"),address:{line1:t.get("shipping_address")}};this.clientSecret?this.stripe.confirmCardPayment(this.clientSecret,{payment_method:{card:this.card,billing_details:n}}).then(i=>{i.error?(this.showError(i.error.message),this.setLoading(!1)):i.paymentIntent.status==="succeeded"&&this.form.submit()}):(console.warn("No client secret found, submitting form without payment processing"),setTimeout(()=>{this.form.submit()},1e3))}initializePayment(){if(this.form=document.getElementById("payment-form"),this.paymentElement=document.getElementById("payment-element"),this.errorElement=document.getElementById("error-message"),this.submitButton=document.getElementById("submit-button"),!this.form||!this.paymentElement){console.warn("Required payment elements not found");return}this.elements.create("payment").mount(this.paymentElement),this.form.addEventListener("submit",this.handlePaymentSubmit.bind(this))}handlePaymentSubmit(e){e.preventDefault(),this.setLoading(!0),this.clientSecret?this.stripe.confirmPayment({elements:this.elements,confirmParams:{return_url:this.orderCompleteUrl||window.location.origin}}).then(t=>{t.error&&(this.showError(t.error.message),this.setLoading(!1))}):(console.warn("No client secret found"),this.setLoading(!1))}initializePaymentMethods(){var l;const e=document.getElementById("add-payment-method-card"),t=document.getElementById("add-payment-method-form"),n=(l=document.getElementById("customer-id"))==null?void 0:l.value,i=document.getElementById("payment-methods-container"),a=document.getElementById("payment-method-errors");if(!e||!t){console.warn("Required payment method elements not found");return}const r=this.elements.create("card",{style:{base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}});r.mount(e),t.addEventListener("submit",async d=>{d.preventDefault();const m=document.getElementById("cardholder_name").value;try{const o=await this.stripe.createPaymentMethod({type:"card",card:r,billing_details:{name:m}});o.error?a&&(a.textContent=o.error.message):(console.log("Payment method created:",o.paymentMethod.id),t.reset(),r.clear(),n&&this.loadSavedPaymentMethods&&this.loadSavedPaymentMethods())}catch(o){console.error("Error creating payment method:",o)}}),n&&i&&this.loadSavedPaymentMethods(n,i)}loadSavedPaymentMethods(e,t){!e||!t||(t.innerHTML='<p class="text-center">You have no saved payment methods.</p>')}showError(e){const t=this.cardErrors||this.errorElement;t?(t.textContent=e,t.classList.add("alert","alert-danger","mt-3")):this.showNotification("Payment Error",e,"error")}setLoading(e){this.submitButton&&(e?(this.submitButton.disabled=!0,this.submitButton.innerHTML=`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Processing...
            `):(this.submitButton.disabled=!1,this.submitButton.innerHTML="Pay Now"))}showNotification(e,t,n){typeof Swal<"u"?Swal.fire({title:e,text:t,icon:n,confirmButtonColor:"#0d6efd"}):alert(`${e}: ${t}`)}}document.addEventListener("DOMContentLoaded",function(){const s=new c;window.StripePaymentManager=s});
