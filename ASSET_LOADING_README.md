# Asset Loading System Documentation

## Overview

This document explains how the asset loading system works in the Skunkmonkey project, especially for Heroku deployment.

## New Local-Build Approach

We've moved to a simpler approach that uses locally built assets instead of building them during Heroku deployment:

1. **Why This Change?**
   - The previous approach had issues with file paths and MIME types in Heroku
   - Building on Heroku with the Node.js buildpack was causing inconsistent results
   - Pre-building assets locally gives more predictable results

2. **How It Works**
   - Assets are built locally using the `build_local_assets.sh` script
   - The built files are committed to the repository
   - No Node.js buildpack is required on Heroku
   - Files follow a simplified, predictable structure

3. **Steps to Use the New Approach**
   - Run the `./build_local_assets.sh` script before deployment
   - Replace the existing `direct_assets.py` with `direct_assets.py.new`
   - Commit the built assets to your repository
   - Remove the Node.js buildpack from your Heroku app

## How Assets Are Loaded

1. **Development Mode**:
   - In development mode, assets are loaded from the Vite dev server (localhost:5173)
   - This allows for hot module replacement and faster development

2. **Production Mode**:
   - In production, assets are served from static files generated by the build process
   - Assets follow a simple structure with JavaScript in `/static/js/` and CSS in `/static/css/`
   - The system looks for the manifest.json file to map asset names to their file paths

## Key Components

### 1. direct_assets.py

This templatetag is responsible for generating the HTML tags (script and link) for loading assets:

- It reads the manifest.json file to find the correct paths
- It adds proper MIME types to CSS files
- It handles module preloading for dependencies
- It uses multiple fallback paths for maximum compatibility

### 2. build_local_assets.sh

This script handles building assets locally before deployment:

```bash
# Build assets with the local config
cd frontend
NODE_ENV=production npx vite build --config vite.config.local.js

# Copy manifest to additional locations for compatibility
cp -f ../static/manifest.json ../static/.vite/manifest.json
```

### 3. vite.config.local.js

This configuration produces a simpler output structure:

```javascript
export default defineConfig({
  base: '/static/',
  build: {
    outDir: '../static',
    rollupOptions: {
      output: {
        // Simplified output structure
        chunkFileNames: 'js/chunks/[name].[hash].js',
        entryFileNames: 'js/[name].js',
        assetFileNames: 'css/[name][extname]' // for CSS files
      }
    }
  }
});
```

### 4. Asset Health Check

You can check the health of your assets by visiting the `/asset-health/` URL, which will show:

- Which assets are loading correctly
- Which assets are failing to load
- The MIME types being used

## Common Issues and Solutions

1. **CSS files loading with wrong MIME type**
   - Fixed by explicitly setting `type="text/css"` in the link tags

2. **JavaScript files returning 404 errors**
   - Fixed by ensuring all JS files are loaded from the `/js/core/` directory
   - The system now provides proper fallbacks if a file isn't found

3. **Vendor chunks not being found**
   - Fixed by preloading dependencies with `<link rel="modulepreload">` tags
   - Vendor files are referenced from multiple locations for compatibility

## Asset File Structure

After running the local build script, assets follow this structure:

```
static/
├── css/
│   ├── main.css
│   └── [other-entry].css
├── js/
│   ├── chunks/
│   │   └── [chunk-name].[hash].js
│   ├── main.js
│   └── [other-entry].js
└── manifest.json
```

## Migration Steps

To migrate from the previous approach:

1. Run `./build_local_assets.sh` to generate assets locally
2. Replace `skunkmonkey/templatetags/direct_assets.py` with `direct_assets.py.new`
3. Commit the built assets to your repository
4. Remove the Node.js buildpack from your Heroku app
5. Deploy to Heroku
6. Verify assets load correctly

## Troubleshooting

If you encounter asset loading issues:

1. Check that you've run `./build_local_assets.sh` before deployment
2. Use the `{% debug_manifest %}` tag in templates to inspect asset paths
3. Verify files exist in `static/js/` and `static/css/` directories
4. Check browser console for 404 errors or other loading issues
5. Ensure the correct MIME types are being used for CSS files
